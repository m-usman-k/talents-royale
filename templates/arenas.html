{% extends "base.html" %}

{% block title %} {% endblock %}

{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'css/arenas.css' %}">
    <script src="{% static 'scripts/arenas-animations.js' %}" defer></script>
    <section class="main-arena">
        <h2>CHOOSE YOUR ARENA<br>BEGIN YOUR RISE</h2>
        <p>Only 100 Leaderboard Spots Per Arena<br>Will You Claim One?</p>

        <div class="arena-cards">
            {% for arena in arenas %}
            <div class="each-card">
                <h4>{{ arena.get_tier_display }}<br>Arena</h4>
                <h3>{{ arena.token_cost }} ðŸª™</h3>
                <p>{{ arena.description }}</p>
                {% if user.is_authenticated %}
                    {% if arena.id in user_arenas %}
                        <button disabled style="opacity: 0.6; cursor: not-allowed;">ALREADY JOINED</button>
                    {% elif user.tokens < arena.token_cost %}
                        <button disabled style="opacity: 0.6; cursor: not-allowed;">INSUFFICIENT TOKENS</button>
                    {% else %}
                        <button onclick="joinArena({{ arena.id }})" data-arena-id="{{ arena.id }}">JOIN ARENA</button>
                    {% endif %}
                {% else %}
                    <button onclick="window.location.href='/login'">LOGIN TO JOIN</button>
                {% endif %}
            </div>
            {% empty %}
            <div style="grid-column: 1 / -1; text-align: center; color: white; padding: 2rem;">
                <p style="font-size: 1.2rem; margin-bottom: 1rem;">No arenas available at the moment.</p>
                <p style="opacity: 0.8;">Please check back later or contact an administrator.</p>
            </div>
            {% endfor %}
        </div>

        <h2>CROWNED VICTOR EARNS UNLIMITED<br>ARENA ACCESS & HALL OF FAME STATUS</h2>
        
        <h2 class="mm-h2">PICK YOUR TIER<br>PLAY LIKE ROYALTY</h2>
        
        <div class="tier-cards">
            {% for arena in arenas %}
            <div class="tier-card {% if arena.tier == 'recruit' %}blue-tier-card{% elif arena.tier == 'veteran' %}black-tier-card{% elif arena.tier == 'champion' %}red-tier-card{% elif arena.tier == 'elite' %}golden-tier-card{% endif %}">
                <img src="/static/images/tr-{{ arena.tier }}-tier.png" alt="{{ arena.get_tier_display }} Tier Icon" onerror="this.src='/static/images/tr-recruit-tier.png'">
                <h3>{{ arena.get_tier_display|upper }}</h3>
                <p>{{ arena.description }}</p>
                {% if user.is_authenticated %}
                    {% if arena.id in user_arenas %}
                        <button disabled style="opacity: 0.6; cursor: not-allowed;">ALREADY JOINED</button>
                    {% elif user.tokens < arena.token_cost %}
                        <button disabled style="opacity: 0.6; cursor: not-allowed;">NEED {{ arena.token_cost }} TOKENS</button>
                    {% else %}
                        <button onclick="joinArena({{ arena.id }})" data-arena-id="{{ arena.id }}">Join Tier ({{ arena.token_cost }} ðŸª™)</button>
                    {% endif %}
                {% else %}
                    <button onclick="window.location.href='/login'">LOGIN TO JOIN</button>
                {% endif %}
            </div>
            {% empty %}
            <div style="text-align: center; color: white; padding: 2rem;">
                <p style="font-size: 1.2rem; margin-bottom: 1rem;">No tiers available at the moment.</p>
                <p style="opacity: 0.8;">Please check back later or contact an administrator.</p>
            </div>
            {% endfor %}
        </div>
    </section>

    <script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function joinArena(arenaId) {
        if (!confirm('Are you sure you want to join this arena? Tokens will be deducted.')) {
            return;
        }
        
        const csrftoken = getCookie('csrftoken');
        fetch('/api/join-arena/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                arena_id: arenaId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    alert(data.message);
                    location.reload();
                }
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
    </script>
{% endblock %}
