<!-- contestants.html -->
{% extends "base.html" %}

{% block title %} {% endblock %}

{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'css/contestants.css' %}">
    <script src="{% static 'scripts/contestants-animations.js' %}" defer></script>
    <section class="main-contestants">
        <div class="header-section">
            <div class="logo-container">
                <img src="{% static 'images/tr-blue-crown.png' %}" alt="Talents Royale Logo" class="logo-image">
                <h1 class="logo-text">TALENTS<br/>ROYALE</h1>
            </div>
            
            <div class="month-selector">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; justify-content: center;">
                    <select id="arenaDropdown" class="month-dropdown" onchange="updateFilters()">
                        <option value="">All Arenas</option>
                        {% for a in arenas %}
                            <option value="{{ a.id }}" {% if arena and arena.id == a.id %}selected{% endif %}>{{ a.get_tier_display }} Arena</option>
                        {% endfor %}
                    </select>
                    <select id="periodDropdown" class="month-dropdown" onchange="updateFilters()">
                        <option value="all" {% if selected_period == 'all' or not selected_period %}selected{% endif %}>All Time</option>
                        {% for month_option in month_options %}
                            <option value="{{ month_option.value }}" {% if selected_period == month_option.value %}selected{% endif %}>{{ month_option.label }}</option>
                        {% endfor %}
                    </select>
                    <script>
                        function updateFilters() {
                            const arena = document.getElementById('arenaDropdown').value;
                            const period = document.getElementById('periodDropdown').value;
                            let url = '/contestants?';
                            if (arena) url += 'arena=' + arena + '&';
                            if (period && period !== 'all') url += 'period=' + period;
                            if (url.endsWith('&')) url = url.slice(0, -1);
                            if (url.endsWith('?')) url = url.slice(0, -1);
                            window.location.href = url;
                        }
                    </script>
                </div>
                <p class="arena-rankings">{% if arena %}{{ arena.get_tier_display }} Arena Rankings{% else %}All Arena Rankings{% endif %}</p>
            </div>
        </div>

        <div class="ranking-section">
            <div class="top-contestants">
                {% for contestant in top_contestants %}
                <div class="contestant-card arena-{{ contestant.arena.tier }}" onclick="window.location.href='/contestant/{{ contestant.id }}/'" style="cursor: pointer;">
                    <div class="arena-badge">{{ contestant.arena.get_tier_display|upper }}</div>
                    <div class="contestant-image">
                        {% if contestant.user.profile_photo %}
                            <img src="{{ contestant.user.profile_photo.url }}" alt="{{ contestant.user.username }}">
                        {% else %}
                            <img src="{% static 'images/tr-profile-icon.png' %}" alt="{{ contestant.user.username }}">
                        {% endif %}
                    </div>
                    <div class="contestant-info">
                        <h3>{{ contestant.user.username }}</h3>
                        <p class="submission-title">{{ contestant.title }}</p>
                        <p class="votes" id="votes-{{ contestant.id }}">{{ contestant.votes|floatformat:0 }} votes</p>
                        {% if user.is_authenticated %}
                            {% if contestant.id in user_votes %}
                                <button class="vote-button" onclick="event.stopPropagation(); voteAgain({{ contestant.id }})">Vote Again (5 ðŸª™)</button>
                            {% else %}
                                <button class="vote-button" onclick="event.stopPropagation(); voteContestant({{ contestant.id }})">Free Vote</button>
                            {% endif %}
                        {% else %}
                            <button class="vote-button" onclick="event.stopPropagation(); window.location.href='/login'">Login to Vote</button>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p style="color: white; text-align: center; grid-column: 1 / -1;">No contestants yet. Be the first to join!</p>
                {% endfor %}
            </div>

            <div class="ranking-list">
                {% for contestant in other_contestants %}
                <div class="rank-item" onclick="window.location.href='/contestant/{{ contestant.id }}/'" style="cursor: pointer;">
                    <span class="rank-number">{% if arena %}{{ forloop.counter|add:3 }}{% else %}{{ forloop.counter|add:top_contestants|length }}{% endif %}</span>
                    <div class="contestant-image-small">
                        {% if contestant.user.profile_photo %}
                            <img src="{{ contestant.user.profile_photo.url }}" alt="{{ contestant.user.username }}">
                        {% else %}
                            <img src="{% static 'images/tr-profile-icon.png' %}" alt="{{ contestant.user.username }}">
                        {% endif %}
                    </div>
                    <div class="rank-details">
                        <h3>{{ contestant.user.username }}</h3>
                        <p style="color: #FFA200; font-size: 0.85rem; margin: 0.25rem 0;">{{ contestant.title }}</p>
                        <p style="color: #00E5FF; font-size: 0.75rem; margin: 0.15rem 0;">{{ contestant.arena.get_tier_display }} Arena</p>
                        <p class="votes" id="votes-{{ contestant.id }}">{{ contestant.votes|floatformat:0 }} votes</p>
                    </div>
                    {% if user.is_authenticated %}
                        {% if contestant.id in user_votes %}
                            <button class="vote-button" onclick="event.stopPropagation(); voteAgain({{ contestant.id }})">Vote Again (5 ðŸª™)</button>
                        {% else %}
                            <button class="vote-button" onclick="event.stopPropagation(); voteContestant({{ contestant.id }})">Free Vote</button>
                        {% endif %}
                    {% else %}
                        <button class="vote-button" onclick="event.stopPropagation(); window.location.href='/login'">Login to Vote</button>
                    {% endif %}
                </div>
                {% empty %}
                <p style="color: white; text-align: center;">No more contestants to display.</p>
                {% endfor %}
            </div>
        </div>

        <p class="cta-text">Have what it takes? Choose your<br> arena and upload your talent for a<br>chance to rise</p>
        
        <button class="enter-arena-button" onclick="window.location.href='/arenas'">Enter an Arena</button>
    </section>

    <script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function voteContestant(contestantId) {
        const csrftoken = getCookie('csrftoken');
        fetch('/api/vote/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                contestant_id: contestantId,
                use_tokens: false
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('votes-' + contestantId).textContent = data.new_votes + ' votes';
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    function voteAgain(contestantId) {
        if (!confirm('Vote again for 5 tokens?')) {
            return;
        }
        
        const csrftoken = getCookie('csrftoken');
        fetch('/api/vote/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                contestant_id: contestantId,
                use_tokens: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('votes-' + contestantId).textContent = data.new_votes + ' votes';
                alert(data.message + ' Remaining tokens: ' + data.remaining_tokens);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
    </script>
{% endblock %}